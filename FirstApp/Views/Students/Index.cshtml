@model IEnumerable<FirstApp.Models.Student>

@{
    ViewData["Title"] = "Student";
}


<div class="card shadow">
    <div class="card-header">
        <div class="flex-container row row-cols-2">
            <div class="col"><h1>@ViewData["Title"]</h1></div>
            <div class="col text-end"><a asp-action="Create" class="btn btn-primary">Create New</a></div>
        </div>
    </div>
    <div class="card-body">
<table class="table" id="StudentTable">
    <thead>
        <tr>
            <th>
                @Html.DisplayNameFor(model => model.Name)
            </th>
            <th>
                @Html.DisplayNameFor(model => model.Enrolled)
            </th>
            <th>
                Actions
            </th>
            <th></th>
        </tr>
    </thead>
    <tbody>

    </tbody>
</table>
    </div>
</div>

<input type="hidden" id="hiddenId"/>
<input type="hidden" id="hiddenName" />
<input type="hidden" id="hiddenEnrolled" />

@*  Delete Modal *@
<div class="modal fade" id="DeleteModal">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h4 class="modal-title">Delete</h4>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <p>Are you sure you want to delete <strong id="studentName"></strong>?</p>
            </div> 
            <div class="modal-footer">
                <button type="button" class="btn btn-danger" id="deleteBtn">Confirm</button>
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
            </div>
        </div>
    </div>
</div>

@* Edit Modal *@
<div class="modal fade" id="EditModal">
    <div class="modal-dialog">
        <div class="modal-content"> 
            <div class="modal-header">
                <h4 class="modal-title">
                    Edit Student
                </h4>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form asp-action="Edit" id="EditStudent">
                    <div asp-validation-summary="ModelOnly" class="text-danger"></div>
                    <input type="hidden" id="ID" name="ID" />
                    <div class="form-group">
                        <label for="Name" class="control-label"></label>
                        <input id="Name" name="Name" class="form-control" />
                    </div>
                    <div class="form-group">
                        <label for="Enrolled" class="control-label"></label>
                        <input id="Enrolled" name="Enrolled" class="form-control" />
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="submit" class="btn btn-primary" id="StudentUpdate">Update</button>
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancle</button>
            </div>
        </div>
    </div>
</div> 

@* tost massage *@
<div class="position-fixed top-0 end-0 p-3" style="z-index: 1055">
    <div id="toastMsg" class="toast fade align-items-center bg-danger text-white border-0" role="alert" aria-live="assertive" aria-atomic="true">
        <div class="d-flex">
            <div class="toast-body">
                Student deleted successfully!
            </div>
            <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast" aria-label="Close"></button>
        </div>
    </div>
</div>
@section Scripts {
    <script>
        function DeleteItem(id, name) {
            $("#hiddenId").val(id);
            $('#hiddenName').val(name);
            $('#studentName').text(name);
            $("#DeleteModal").modal('show');
        }

        function EditStudent(id, name, enrolled) { 
            $("#ID").val(id);
            $("#Name").val(name);
            $("#Enrolled").val(enrolled);
            $("#EditModal").modal('show');
        }

        $(document).ready(function () {

            // Initialize DataTable
            $('#StudentTable').DataTable({
                "ajax": {
                    "url": "/Students/GetAllStudents",
                    "type": "GET",
                    "dataType": "json"
                },
                "columns": [
                    { "data": "name" },
                    { "data": "enrolled" },
                    {
                        "data": "id",
                        "render": function (data, type, row) {
                            return `
                                <a href="#" class="btn btn-warning btn-sm" onclick="EditStudent(${data}, '${row.name}', '${row.enrolled}')">Edit</a>
                                <a href="#" class="btn btn-danger btn-sm" onclick="DeleteItem(${data}, '${row.name}')">Delete</a>
                            `;
                        },
                        "orderable": false
                    }
                ]
            });

            // Handle Delete Confirm Button
            $("#deleteBtn").click(function () {
                var id = $("#hiddenId").val();

                $.ajax({
                    type: "POST",
                    url: "/Students/Delete",
                    data: { id: id },
                    success: function () {
                        $("#DeleteModal").modal('hide');
                        $("#StudentTable").DataTable().ajax.reload();

                        var toastMsg = $("#toastMsg");
                        var toast = new bootstrap.Toast(toastMsg, { delay: 3000 });
                        toast.show();
                    },
                    error: function () {
                        alert("Error deleting student.");
                    }
                });
            });

            // jQuery Validate Edit Form
            $("#EditStudent").validate({
                rules: {
                    Name: {
                        required: true,
                        minlength: 3
                    },
                    Enrolled: {
                        required: true,
                        date: true
                    }
                },
                messages: {
                    Name: {
                        required: "Please enter a name",
                        minlength: "Name must be at least 3 characters"
                    },
                    Enrolled: {
                        required: "Please enter enrollment date",
                        date: "Please enter a valid date"
                    }
                },
                errorClass: "text-danger",
                submitHandler: function (form) {
                    var id = $("#ID").val();
                    var name = $("#Name").val();
                    var enrolled = $("#Enrolled").val();

                    $.ajax({
                        type: "POST",
                        url: "/Students/Edit",
                        data: {
                            ID: id,
                            Name: name,
                            Enrolled: enrolled
                        },
                        success: function () {
                            $("#EditModal").modal('hide');
                            alert("Student updated successfully!");
                            $("#StudentTable").DataTable().ajax.reload();
                        },
                        error: function () {
                            alert("Error updating student.");
                        }
                    });

                    return false;
                }
            });

            // Trigger submit on update button click
            $("#StudentUpdate").click(function () {
                $("#EditStudent").submit();
            });
        });
    </script>
    @{
        await Html.RenderPartialAsync("_ValidationScriptsPartial");
    }
}
